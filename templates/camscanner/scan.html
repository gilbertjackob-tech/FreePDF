{% extends 'base.html' %}
{% block content %}
<section class="hero py-4 mb-3">
  <div class="container text-center">
    <h1 class="h3 fw-bold">Scanner</h1>
    <p class="lead mb-3">Capture document pages with camera or upload images. Tap the shutter to add to your scan session.</p>
  </div>
</section>

<section class="container mb-5">
  <div class="row">
    <div class="col-lg-8">
      <div class="card shadow-sm p-0">
        <div class="position-relative" style="aspect-ratio:4/3; background:#000;">
          <video id="scanner_video" autoplay playsinline muted class="w-100 h-100" style="object-fit:cover;"></video>
          <canvas id="scanner_canvas" class="d-none"></canvas>
          <div id="scanner_overlay" class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-end justify-content-center p-3 pointer-events-none">
            <div class="bg-black bg-opacity-50 text-white rounded px-3 py-2 pointer-events-auto" id="scanner_status">Ready</div>
          </div>
        </div>
        <div class="card-body d-flex gap-2 align-items-center justify-content-center flex-wrap">
          <button id="shutter_btn" class="btn btn-primary btn-lg">ðŸ“¸ Capture</button>
          <button id="flip_btn" class="btn btn-outline-secondary">Flip Camera</button>
          <button id="upload_btn" class="btn btn-outline-warning">Upload Image(s)</button>
          <input type="file" id="file_input" accept="image/*" style="display:none" multiple>
          <button id="done_btn" class="btn btn-outline-success">Finish & Save</button>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm p-3">
        <h6>Captured Pages</h6>
        <div id="scan_gallery" class="d-flex flex-column gap-2" style="max-height:60vh; overflow:auto;"></div>
        <div class="mt-3 d-flex gap-2 flex-wrap">
          <button id="clear_session" class="btn btn-sm btn-outline-danger">Clear</button>
        </div>
        <div id="scan_progress_wrap" style="display:none; margin-top:5px;">
          <div id="scan_progress_fill" style="width:0%; height:10px; background:#28a745;"></div>
          <div id="scan_progress_text" style="font-size:0.9em; margin-top:2px;">Uploading...</div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
(async function(){
  const video = document.getElementById('scanner_video');
  const canvas = document.getElementById('scanner_canvas');
  const shutterBtn = document.getElementById('shutter_btn');
  const flipBtn = document.getElementById('flip_btn');
  const uploadBtn = document.getElementById('upload_btn');
  const fileInput = document.getElementById('file_input');
  const doneBtn = document.getElementById('done_btn');
  const galleryDiv = document.getElementById('scan_gallery');
  const statusDiv = document.getElementById('scanner_status');
  const wrap = document.getElementById('scan_progress_wrap');
  const fill = document.getElementById('scan_progress_fill');
  const text = document.getElementById('scan_progress_text');

  let stream = null;
  let usingFrontCamera = false;
  let capturedPages = [];

  async function startCamera() {
    if(stream){ stream.getTracks().forEach(t=>t.stop()); }
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: usingFrontCamera?"user":"environment" } });
      video.srcObject = stream;
      statusDiv.innerText = "Ready";
    } catch(e){
      console.warn("Camera not available", e);
      statusDiv.innerText = "Camera not available. Use upload.";
    }
  }

  flipBtn.addEventListener('click', ()=>{ usingFrontCamera = !usingFrontCamera; startCamera(); });

  uploadBtn.addEventListener('click', ()=>fileInput.click());
  fileInput.addEventListener('change', e=>{
    for(const f of e.target.files){
      capturedPages.push(f);
      const url = URL.createObjectURL(f);
      const thumb = document.createElement('img'); thumb.src=url; thumb.className='img-fluid border';
      galleryDiv.appendChild(thumb);
    }
    e.target.value='';
  });

  async function capturePage(){
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video,0,0);
    return new Promise(resolve=>canvas.toBlob(resolve,'image/jpeg',0.9));
  }

  shutterBtn.addEventListener('click', async ()=>{
    if(!stream){ alert("Camera not available. Use Upload."); return; }
    statusDiv.innerText="Processing...";
    try {
      const blob = await capturePage();
      const fd = new FormData();
      fd.append('file', blob, 'page.jpg');
      const res = await fetch('/scan-perspective', { method:'POST', body: fd });
      if(!res.ok){ statusDiv.innerText="Error"; return; }
      const processedBlob = await res.blob();
      capturedPages.push(processedBlob);
      const url = URL.createObjectURL(processedBlob);
      const thumb = document.createElement('img'); thumb.src=url; thumb.className='img-fluid border';
      galleryDiv.appendChild(thumb);
      statusDiv.innerText="Ready";
    } catch(e){ console.error(e); statusDiv.innerText="Error"; }
  });

  doneBtn.addEventListener('click', async ()=>{
    if(!capturedPages.length){ alert("No pages captured"); return; }
    const fd = new FormData();
    capturedPages.forEach((b,i)=> fd.append('file', b, `page${i+1}.jpg`));
    wrap.style.display='block'; fill.style.width='0%'; text.textContent='Uploading...';
    try {
      const res = await uploadWithProgress('/merge-pdf', fd, (loaded,total)=>{
        const pct = total ? Math.round((loaded/total)*100) : 40;
        fill.style.width=pct+'%'; text.textContent='Uploading... '+pct+'%';
      });
      fill.style.width='100%'; text.textContent='Processing...';
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      window.open(url,'_blank');
    } catch(e){ console.error(e); text.textContent='Error'; }
    finally{ setTimeout(()=>{ wrap.style.display='none'; fill.style.width='0%'; },800); }
  });

  document.getElementById('clear_session').addEventListener('click', ()=>{
    capturedPages=[]; galleryDiv.innerHTML=''; statusDiv.innerText="Ready";
  });

  if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){ startCamera(); } 
  else { statusDiv.innerText="Camera unsupported. Use upload."; }

  function uploadWithProgress(url, formData, onProgress){
    return new Promise((resolve,reject)=>{
      const xhr = new XMLHttpRequest();
      xhr.open('POST', url, true);
      xhr.responseType='blob';
      xhr.upload.onprogress = e=>{ if(onProgress) onProgress(e.loaded,e.total); };
      xhr.onload = ()=>{ 
        if(xhr.status>=200 && xhr.status<300){ 
          resolve(new Response(xhr.response, { status:xhr.status, statusText:xhr.statusText })); 
        } else reject(new Error('Upload failed: '+xhr.status)); 
      };
      xhr.onerror = ()=>reject(new Error('Network error'));
      xhr.send(formData);
    });
  }
})();
</script>
{% endblock %}
